<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Soulmate Consciousness</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="wrap" aria-labelledby="pageTitle">
    <aside class="visual">
      <div class="logo">♡</div>
      <h3 id="pageTitle">Gửi Tâm Sự</h3>
      <p>Viết điều bạn muốn nói</p>
    </aside>

    <form id="confideForm" novalidate>
      <!-- Thay endpoint của bạn tại đây -->
      <input type="hidden" id="FORM_ENDPOINT" value="https://formspree.io/f/mdkyorzy">

      <div style="position:absolute;left:-2000px;">
        <label for="hp">Không điền ô này</label>
        <input id="hp" name="hp" autocomplete="off">
      </div>

      <div class="row">
        <div class="col">
          <label for="name">Tên</label>
          <input id="name" name="name" type="text">
        </div>
        <div class="col">
          <label for="email">Email</label>
          <input id="email" name="email" type="email">
        </div>
      </div>

      <div>
        <label for="message">Gửi điều muốn nói</label>
        <textarea id="message" name="message"
          placeholder="Bạn có thể kể chuyện, tâm sự, nhờ tư vấn..."></textarea>
      </div>

      <div class="actions">
        <label class="checkbox">
        </label>

        <button type="submit" class="btn">Gửi tâm sự</button>
        <button type="button" id="clearBtn" class="btn ghost small">Xóa</button>
      </div>

      <div id="statusArea"></div>

      <footer>
      </footer>
    </form>
  </main>

  <script>
    (function(){
      const form = document.getElementById('confideForm');
      const status = document.getElementById('statusArea');
      const endpointInput = document.getElementById('FORM_ENDPOINT');
      const clearBtn = document.getElementById('clearBtn');
      const OWNER_EMAIL = 'legiathinh203707@gmail.com';

      function showMessage(text, isError){
        status.innerHTML = '<div class="'+(isError? '':'success')+'">'+text+'</div>';
      }

      clearBtn.addEventListener('click', ()=>{
        form.reset();
        status.innerHTML = '';
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        status.innerHTML = '';
        const message = document.getElementById('message').value.trim();
        const hp = document.getElementById('hp').value;
        if (hp) return;
        if (!message){
          showMessage('Vui lòng nhập tin nhắn trước khi gửi.', true);
          return;
        }

        const data = {
          name: document.getElementById('name').value.trim(),
          email: document.getElementById('email').value.trim(),
          allowReply: document.getElementById('allowReply').checked ? 'yes' : 'no',
          message: message,
          sentAt: new Date().toISOString()
        };

        const endpoint = endpointInput.value && endpointInput.value !== 'YOUR_FORMSPREE_ENDPOINT'
                          ? endpointInput.value.trim() : null;

        if (endpoint){
          try {
            showMessage('Đang gửi...');
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: {'Content-Type':'application/json','Accept':'application/json'},
              body: JSON.stringify(data)
            });
            if (res.ok){
              showMessage('Gửi thành công — cảm ơn bạn!');
              form.reset();
            } else {
              showMessage('Không gửi được. Mở mail client.', true);
              openMailClientFallback(data);
            }
          } catch(err){
            showMessage('Không thể kết nối form server. Mở mail client.', true);
            openMailClientFallback(data);
          }
          return;
        }
        openMailClientFallback(data);
      });

      function openMailClientFallback(data){
        const subject = encodeURIComponent('Tâm sự gửi tới bạn');
        const body = encodeURIComponent(
          `Tên: ${data.name || '(ẩn danh)'}\n` +
          `Email: ${data.email || '(không cung cấp)'}\n` +
          `Cho phép trả lời: ${data.allowReply}\n\n` +
          `--- Tin nhắn ---\n${data.message}\n\nGửi lúc: ${data.sentAt}`
        );
        const mailto = `mailto:${OWNER_EMAIL}?subject=${subject}&body=${body}`;
        window.location.href = mailto;
        showMessage('Trình gửi mail sẽ được mở.', false);
      }
    })();
  </script>
</body>
</html>

